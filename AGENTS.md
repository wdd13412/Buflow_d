# AGENTS.md

## Cursor Cloud specific instructions

### Project overview

BuFlow_d is a Fortran-based CFD (Computational Fluid Dynamics) solver with forward-mode automatic differentiation (AD) for airfoil shape optimization. It contains two compilation targets:

- **Primal version** (`buflow_run_test`): runs the CFD pipeline without derivatives
- **AD version** (`buflow_test_d`): runs the Tapenade-generated forward-mode tangent code

### Critical: gfortran version requirement

**You must use `gfortran-10` with `-static-libgfortran`** to compile and run this project. The default `gfortran` (v13) and its runtime library (`libgfortran5` from GCC 14.2.0) reject semicolons in Fortran list-directed I/O, which breaks OpenFOAM boundary file parsing. Using `gfortran-10 -static-libgfortran` embeds the GCC 10 runtime that tolerates semicolons.

### Build commands

```bash
# Primal (non-AD) version:
gfortran-10 -O2 -static-libgfortran TypesModule.f90 meshdeformationn.f90 BuFlow_test.f90 main.f90 run_parameter.f90 \
  -o buflow_run_test -llapack -lblas

# AD (differentiated) version:
gfortran-10 -O2 -static-libgfortran TypesModule.f90 meshdeformationn_d.f90 BuFlow_test_d.f90 main_d.f90 run_parameter_d_AAA.f90 \
  -o buflow_test_d -llapack -lblas
```

### Running

Both binaries must be executed from the repository root (`/workspace`) because they read data from relative paths:
- `mesh/OFairfoilMesh/` (OpenFOAM mesh data)
- `wing.csv` (RAE2822 airfoil coordinates)
- `boundary_inoutput_xy.csv`

```bash
cd /workspace
./buflow_run_test   # primal CFD solver (~53s)
./buflow_test_d     # AD version (~2s, fewer timesteps)
```

### Notes

- No Makefile, CMake, or build system exists; compilation is done via direct `gfortran` invocations.
- No automated test suite exists; correctness is verified by running the binaries and checking output.
- The `*_d.f90` files are auto-generated by INRIA Tapenade 3.16 and should not be manually edited.
- Pre-compiled ELF binaries are committed to the repo but will fail on this environment due to the libgfortran version mismatch described above.
