# BuFlow_d — Forward Automatic Differentiation for CFD

Fortran 90 project: an unstructured-mesh CFD solver (finite-volume, JST flux) with forward-mode automatic differentiation generated by Tapenade (INRIA).

## Cursor Cloud specific instructions

### System dependencies

`gfortran`, `liblapack-dev`, and `libblas-dev` must be installed (the update script handles this).

### Build — original program

Compilation order matters (modules must be compiled before their dependents):

```bash
gfortran -c TypesModule.f90
gfortran -c BuFlow_test.f90
gfortran -c meshdeformationn.f90
gfortran -c main.f90
gfortran -c run_parameter.f90
gfortran TypesModule.o BuFlow_test.o meshdeformationn.o main.o run_parameter.o -o buflow_run_test -llapack -lblas
```

### Build — differentiated (AD) program

```bash
gfortran -c TypesModule.f90
gfortran -c BuFlow_test_d.f90
gfortran -c meshdeformationn_d.f90
gfortran -c main_d.f90
gfortran -c run_parameter_d_AAA.f90
gfortran TypesModule.o BuFlow_test_d.o meshdeformationn_d.o main_d.o run_parameter_d_AAA.o -o buflow_test_d -llapack -lblas
```

### Run

Both binaries must be executed from the repository root (they read `wing.csv`, `boundary_inoutput_xy.csv`, and `mesh/OFairfoilMesh/` via relative paths).

```bash
./buflow_run_test      # original CFD solver
./buflow_test_d        # forward-mode AD variant
```

### Known issue

Both programs currently fail during `readOFBoundaryFile` with: `Fortran runtime error: Semicolon not allowed as separator with DECIMAL='point'`. The OpenFOAM boundary file contains lines like `nFaces 99;` and the Fortran list-directed `read(..., *)` cannot parse the trailing semicolons. The mesh deformation phase (airfoil shape update, RBF interpolation) runs successfully before this point. This is a pre-existing code bug (pre-compiled binaries in the repo exhibit the same error).

### Project structure

| File | Role |
|------|------|
| `TypesModule.f90` | Base type definitions (int64, real64) |
| `BuFlow_test.f90` / `BuFlow_test_d.f90` | CFD solver module (original / AD) |
| `meshdeformationn.f90` / `meshdeformationn_d.f90` | Mesh deformation module (original / AD) |
| `main.f90` / `main_d.f90` | Main orchestration module (original / AD) |
| `run_parameter.f90` | Entry point — original program |
| `run_parameter_d_AAA.f90` | Entry point — differentiated program |
| `wing.csv` | RAE2822 airfoil coordinates |
| `boundary_inoutput_xy.csv` | Boundary I/O point coordinates |
| `mesh/OFairfoilMesh/` | OpenFOAM mesh (points, faces, owner, neighbour, boundary) |
